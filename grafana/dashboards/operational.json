{
  "annotations": {
    "list": []
  },
  "editable": true,
  "schemaVersion": 39,
  "version": 1,
  "title": "WBScanner Operational",
  "panels": [
    {
      "type": "stat",
      "title": "Messages Ingested",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_messages_ingested_total[5m]))"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "Cache Hit Ratio",
      "gridPos": {
        "x": 6,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(rate(wbscanner_cache_hits_total[5m]))/(sum(rate(wbscanner_cache_hits_total[5m]))+sum(rate(wbscanner_cache_misses_total[5m])))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Scan Latency P95",
      "gridPos": {
        "x": 0,
        "y": 4,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_scan_latency_seconds_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "VT Submissions",
      "gridPos": {
        "x": 0,
        "y": 10,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_vt_submissions_total[5m]))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "GSB Hits",
      "gridPos": {
        "x": 6,
        "y": 10,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_gsb_hits_total[5m]))"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "VT Quota Remaining",
      "gridPos": {
        "x": 0,
        "y": 14,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "(wbscanner_api_quota_remaining{service=\"virustotal\"}) OR on() vector(0)"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "WhoisXML Quota Remaining",
      "gridPos": {
        "x": 6,
        "y": 14,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "(wbscanner_api_quota_remaining{service=\"whoisxml\"}) OR on() vector(0)"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Queue Depth",
      "gridPos": {
        "x": 0,
        "y": 18,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "wbscanner_queue_depth"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Shortener Fallback Errors",
      "gridPos": {
        "x": 0,
        "y": 24,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_shortener_expansions_total{method=\"urlexpander\",result=\"error\"}[5m]))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Homoglyph Detections",
      "gridPos": {
        "x": 6,
        "y": 24,
        "w": 6,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_homoglyph_detections_total[5m]))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Verdicts by Level",
      "gridPos": {
        "x": 0,
        "y": 28,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "sum by(level) (increase(wbscanner_verdicts_total[5m]))"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "VT Quota Utilization",
      "gridPos": {
        "x": 0,
        "y": 34,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "(wbscanner_api_quota_utilization_ratio{service=\"virustotal\"}) OR on() vector(0)"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "Whois Utilization",
      "gridPos": {
        "x": 4,
        "y": 34,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "(wbscanner_api_quota_utilization_ratio{service=\"whoisxml\"}) OR on() vector(0)"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Limiter Queue Depth",
      "gridPos": {
        "x": 8,
        "y": 34,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "wbscanner_rate_limiter_queue_depth{service=\"virustotal\"}"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Quota Depletion ETA",
      "gridPos": {
        "x": 0,
        "y": 38,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "sum by(service) (wbscanner_api_quota_projected_depletion_seconds)"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Queue Wait P95",
      "gridPos": {
        "x": 0,
        "y": 44,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_queue_job_wait_seconds_bucket[5m])) by (queue, le))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Queue Processing P95",
      "gridPos": {
        "x": 0,
        "y": 50,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_queue_processing_duration_seconds_bucket[5m])) by (queue, le))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Queue Failures (5m)",
      "gridPos": {
        "x": 0,
        "y": 56,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_queue_failures_total[5m]))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Active Jobs",
      "gridPos": {
        "x": 4,
        "y": 56,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(wbscanner_queue_active_jobs)"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Delayed Jobs",
      "gridPos": {
        "x": 8,
        "y": 56,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(wbscanner_queue_delayed_jobs)"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Cache Lookup P95",
      "gridPos": {
        "x": 0,
        "y": 60,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_cache_lookup_duration_seconds_bucket[5m])) by (cache_type, le))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Cache Stale Hits",
      "gridPos": {
        "x": 0,
        "y": 66,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "sum by(cache_type) (increase(wbscanner_cache_stale_total[5m]))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Verdict Latency P95",
      "gridPos": {
        "x": 0,
        "y": 72,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_verdict_latency_seconds_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Verdict Score P75",
      "gridPos": {
        "x": 0,
        "y": 78,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.75, sum(rate(wbscanner_verdict_score_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "gauge",
      "title": "WA Session Ready",
      "gridPos": {
        "x": 0,
        "y": 84,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "wbscanner_wa_session_status{state=\"ready\"}"
        }
      ]
    },
    {
      "type": "stat",
      "title": "WA Drops (5m)",
      "gridPos": {
        "x": 4,
        "y": 84,
        "w": 4,
        "h": 4
      },
      "targets": [
        {
          "expr": "sum(increase(wbscanner_wa_messages_dropped_total[5m]))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "WA Verdict Latency P95",
      "gridPos": {
        "x": 0,
        "y": 88,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(wbscanner_wa_verdict_delivery_latency_seconds_bucket[5m])) by (le))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Circuit States",
      "gridPos": {
        "x": 0,
        "y": 94,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "wbscanner_circuit_breaker_state"
        }
      ]
    }
  ]
}
