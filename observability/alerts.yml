groups:
  - name: wbscanner-alerts
    rules:
      - alert: HighScanLatencyP95
        expr: histogram_quantile(0.95, sum(rate(wbscanner_scan_latency_seconds_bucket[5m])) by (le)) > 15
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "P95 scan latency above 15s"
      - alert: WAClientDown
        expr: up{job="wa-client"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "wa-client not scraping"
      - alert: VirusTotalQuotaLow
        expr: wbscanner_api_quota_remaining{service="virustotal"} < 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "VirusTotal quota nearly exhausted"
      - alert: VirusTotalQuotaExhausted
        expr: wbscanner_api_quota_status{service="virustotal"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "VirusTotal quota exhausted"
      - alert: WhoisXMLQuotaNearLimit
        expr: wbscanner_api_quota_remaining{service="whoisxml"} < 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "WhoisXML API quota low"
      - alert: WhoisXMLQuotaExhausted
        expr: wbscanner_api_quota_status{service="whoisxml"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "WhoisXML API quota exhausted"
      - alert: WhoisXMLFallbackSpike
        expr: increase(wbscanner_whois_results_total{result="fallback"}[15m]) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "WhoisXML lookups frequently falling back to RDAP"
      - alert: QueueDepthHigh
        expr: wbscanner_queue_depth{queue="scan-request"} > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Scan request queue depth is high"
      - alert: ShortenerFallbackErrors
        expr: rate(wbscanner_shortener_expansions_total{method="url-expand",result="error"}[10m]) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "URL expander fallback experiencing errors"
      - alert: HomoglyphSpike
        expr: increase(wbscanner_homoglyph_detections_total[15m]) > 20
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Spike in homoglyph detections"
      - alert: VTQuotaUtilizationHigh
        expr: wbscanner_api_quota_utilization_ratio{service="virustotal"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "VirusTotal quota utilization above 80%"
      - alert: RateLimiterBacklog
        expr: wbscanner_rate_limiter_queue_depth{service="virustotal"} > 2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "VirusTotal limiter queue building up"
      - alert: CircuitBreakerOpen
        expr: wbscanner_circuit_breaker_state == 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Circuit breaker open for external dependency"
      - alert: QueueWaitHigh
        expr: histogram_quantile(0.95, sum(rate(wbscanner_queue_job_wait_seconds_bucket[5m])) by (queue, le)) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Queue wait time p95 above 10s"
      - alert: VerdictLatencyHigh
        expr: histogram_quantile(0.95, sum(rate(wbscanner_verdict_latency_seconds_bucket[5m])) by (le)) > 30
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Verdict latency p95 above 30s"
      - alert: CacheStaleBurst
        expr: increase(wbscanner_cache_stale_total[10m]) > 50
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Stale cache hits rising"
      - alert: WADropSpike
        expr: increase(wbscanner_wa_messages_dropped_total[5m]) > 25
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "WhatsApp drops exceeding threshold"

