groups:
  - name: wbscanner-alerts
    rules:
      - alert: HighScanLatencyP95
        expr: histogram_quantile(0.95, sum(rate(wbscanner_scan_latency_seconds_bucket[5m])) by (le)) > 15
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "P95 scan latency above 15s"
      - alert: WAClientDown
        expr: up{job="wa-client"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "wa-client not scraping"
      - alert: VirusTotalQuotaLow
        expr: wbscanner_api_quota_remaining{service="virustotal"} < 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "VirusTotal quota nearly exhausted"
      - alert: VirusTotalQuotaExhausted
        expr: wbscanner_api_quota_status{service="virustotal"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "VirusTotal quota exhausted"
      - alert: WhoisXMLQuotaNearLimit
        expr: wbscanner_api_quota_remaining{service="whoisxml"} < 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "WhoisXML API quota low"
      - alert: WhoisXMLQuotaExhausted
        expr: wbscanner_api_quota_status{service="whoisxml"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "WhoisXML API quota exhausted"
      - alert: WhoisXMLFallbackSpike
        expr: increase(wbscanner_whois_results_total{result="fallback"}[15m]) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "WhoisXML lookups frequently falling back to RDAP"
      - alert: QueueDepthHigh
        expr: wbscanner_queue_depth{queue="scan-request"} > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Scan request queue depth is high"
      - alert: ShortenerFallbackErrors
        expr: rate(wbscanner_shortener_expansions_total{method="url-expand",result="error"}[10m]) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "URL expander fallback experiencing errors"
      - alert: HomoglyphSpike
        expr: increase(wbscanner_homoglyph_detections_total[15m]) > 20
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Spike in homoglyph detections"
      - alert: WAVerdictDeliveryFailures
        expr: increase(wbscanner_wa_verdict_delivery_total{result="failed"}[10m]) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Verdict replies are failing to deliver"
      - alert: WAVerdictDeliveryRetriesHigh
        expr: increase(wbscanner_wa_verdict_delivery_retries_total[10m]) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Verdict delivery retries exceeding threshold"
      - alert: WAAuthFailuresSpiking
        expr: increase(wbscanner_wa_state_changes_total{event="auth_failure"}[5m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Repeated WhatsApp auth failures detected"
      - alert: ExternalProvidersDegraded
        expr: increase(wbscanner_degraded_mode_events_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "All external threat providers are unavailable; system running heuristics-only."
