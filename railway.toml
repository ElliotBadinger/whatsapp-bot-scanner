[build]
builder = "DOCKERFILE"

[[services]]
name = "wa-client"
source = "services/wa-client"
[services.env]
NODE_ENV = "production"

[[services]]
name = "scan-orchestrator"
source = "services/scan-orchestrator"
[services.deploy]
replicas = 2
healthcheckPath = "/healthz"
healthcheckTimeout = 100
startCommand = "npm run migrate && npm start"

[[services]]
name = "control-plane"
source = "services/control-plane"
[services.deploy]
healthcheckPath = "/healthz"
healthcheckTimeout = 100

[[services]]
name = "postgres"
image = "postgres:15-alpine"
[services.env]
POSTGRES_DB = "wbscanner"
POSTGRES_USER = "wbscanner"
POSTGRES_PASSWORD = "wbscanner"

[[services]]
name = "redis"
image = "redis:7-alpine"

[env]
REDIS_URL = "${{ redis.url }}"
DATABASE_URL = "postgres://${{ postgres.env.POSTGRES_USER }}:${{ postgres.env.POSTGRES_PASSWORD }}@${{ postgres.host }}:${{ postgres.port }}/${{ postgres.env.POSTGRES_DB }}"
CONTROL_PLANE_API_TOKEN = "${{ secrets.CONTROL_PLANE_API_TOKEN }}"
VT_API_KEY = "${{ secrets.VT_API_KEY }}"
GSB_API_KEY = "${{ secrets.GSB_API_KEY }}"
WHOISXML_API_KEY = "${{ secrets.WHOISXML_API_KEY }}"
URLSCAN_API_KEY = "${{ secrets.URLSCAN_API_KEY }}"
URLSCAN_CALLBACK_SECRET = "${{ secrets.URLSCAN_CALLBACK_SECRET }}"
