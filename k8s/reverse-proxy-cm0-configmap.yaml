apiVersion: v1
data:
  nginx.conf: "worker_processes auto;\nevents { worker_connections 1024; }\nhttp {\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n  log_format json_combined '{\"time\":\"$time_iso8601\",\"remote_addr\":\"$remote_addr\",\"request\":\"$request\",\"status\":$status,\"body_bytes_sent\":$body_bytes_sent,\"referer\":\"$http_referer\",\"user_agent\":\"$http_user_agent\",\"request_time\":$request_time,\"upstream_response_time\":$upstream_response_time}';\n  access_log /var/log/nginx/access.log json_combined;\n  sendfile on;\n  client_max_body_size 1M;\n  client_body_buffer_size 128k;\n  client_header_buffer_size 1k;\n  large_client_header_buffers 2 1k;\n\n  # Rate limiting\n  limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;\n  limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;\n  limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;\n\n  server {\n    listen 8088;\n    server_name _;\n\n    # Security headers\n    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n    add_header X-Frame-Options \"DENY\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n    add_header Content-Security-Policy \"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';\" always;\n\n    # Connection limits\n    limit_conn conn_limit_per_ip 20;\n\n    location / {\n      limit_req zone=general burst=50 nodelay;\n      root /usr/share/nginx/html;\n      index index.html;\n      try_files $uri $uri/ @control_plane;\n    }\n\n    location @control_plane {\n      limit_req zone=api burst=20 nodelay;\n      proxy_set_header Host $host;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto $scheme;\n      proxy_pass http://control-plane:8080;\n      \n      # Timeouts\n      proxy_connect_timeout 5s;\n      proxy_send_timeout 10s;\n      proxy_read_timeout 10s;\n    }\n\n    # Health check endpoint (no rate limiting)\n    location /healthz {\n      access_log off;\n      return 200 \"healthy\\n\";\n      add_header Content-Type text/plain;\n    }\n  }\n}\n\n"
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: reverse-proxy
  name: reverse-proxy-cm0
